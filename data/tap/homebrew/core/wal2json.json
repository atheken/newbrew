{
  "name": "wal2json",
  "full_name": "wal2json",
  "tap": "homebrew/core",
  "oldname": null,
  "oldnames": [],
  "aliases": [],
  "versioned_formulae": [],
  "desc": "Convert PostgreSQL changesets to JSON format",
  "license": "BSD-3-Clause",
  "homepage": "https://github.com/eulerto/wal2json",
  "versions": {
    "stable": "2.5",
    "head": null,
    "bottle": true
  },
  "urls": {
    "stable": {
      "url": "https://github.com/eulerto/wal2json/archive/wal2json_2_5.tar.gz",
      "tag": null,
      "revision": null,
      "checksum": "b516653575541cf221b99cf3f8be9b6821f6dbcfc125675c85f35090f824f00e"
    }
  },
  "revision": 0,
  "version_scheme": 0,
  "bottle": {
    "stable": {
      "rebuild": 0,
      "root_url": "https://ghcr.io/v2/homebrew/core",
      "files": {
        "arm64_ventura": {
          "cellar": ":any_skip_relocation",
          "url": "https://ghcr.io/v2/homebrew/core/wal2json/blobs/sha256:5b8e99400a6c8d675edacff3d109e8138c291759f11425fbd4cf356004236b41",
          "sha256": "5b8e99400a6c8d675edacff3d109e8138c291759f11425fbd4cf356004236b41"
        },
        "arm64_monterey": {
          "cellar": ":any_skip_relocation",
          "url": "https://ghcr.io/v2/homebrew/core/wal2json/blobs/sha256:7c9dec0653716cd5dcb63a76150b399252776bfa0013dfabdfbc0a2f3e700e89",
          "sha256": "7c9dec0653716cd5dcb63a76150b399252776bfa0013dfabdfbc0a2f3e700e89"
        },
        "arm64_big_sur": {
          "cellar": ":any_skip_relocation",
          "url": "https://ghcr.io/v2/homebrew/core/wal2json/blobs/sha256:0e49db0bc27c9bb9355f9c9c6a032b5dd56b4e70ec03950355367c809e54088d",
          "sha256": "0e49db0bc27c9bb9355f9c9c6a032b5dd56b4e70ec03950355367c809e54088d"
        },
        "ventura": {
          "cellar": ":any_skip_relocation",
          "url": "https://ghcr.io/v2/homebrew/core/wal2json/blobs/sha256:cb45f856e5caf15b5a7b19f34fef94ca798af287a615d82b188d467132519d29",
          "sha256": "cb45f856e5caf15b5a7b19f34fef94ca798af287a615d82b188d467132519d29"
        },
        "monterey": {
          "cellar": ":any_skip_relocation",
          "url": "https://ghcr.io/v2/homebrew/core/wal2json/blobs/sha256:9c340985060a45681159a662d4fe4ff6a19fdf6735c28d2c67f9ae38a052ef20",
          "sha256": "9c340985060a45681159a662d4fe4ff6a19fdf6735c28d2c67f9ae38a052ef20"
        },
        "big_sur": {
          "cellar": ":any_skip_relocation",
          "url": "https://ghcr.io/v2/homebrew/core/wal2json/blobs/sha256:e961f33e907f86ced624dbbddfabc25e66007a83cc89f9e2f6c1a83e440f9e43",
          "sha256": "e961f33e907f86ced624dbbddfabc25e66007a83cc89f9e2f6c1a83e440f9e43"
        },
        "catalina": {
          "cellar": ":any_skip_relocation",
          "url": "https://ghcr.io/v2/homebrew/core/wal2json/blobs/sha256:3438e2f5355834993c39f5a9488138643be8e88ec643420647a38a83d65ac4ee",
          "sha256": "3438e2f5355834993c39f5a9488138643be8e88ec643420647a38a83d65ac4ee"
        },
        "x86_64_linux": {
          "cellar": ":any_skip_relocation",
          "url": "https://ghcr.io/v2/homebrew/core/wal2json/blobs/sha256:d6cec39726b0b3dc1f51319d2831875716e1dec9e5a50a27981f7cee77db1447",
          "sha256": "d6cec39726b0b3dc1f51319d2831875716e1dec9e5a50a27981f7cee77db1447"
        }
      }
    }
  },
  "keg_only": false,
  "keg_only_reason": null,
  "options": [],
  "build_dependencies": [],
  "dependencies": [
    "postgresql@14"
  ],
  "test_dependencies": [],
  "recommended_dependencies": [],
  "optional_dependencies": [],
  "uses_from_macos": [],
  "uses_from_macos_bounds": [],
  "requirements": [],
  "conflicts_with": [],
  "conflicts_with_reasons": [],
  "link_overwrite": [],
  "caveats": null,
  "installed": [],
  "linked_keg": null,
  "pinned": false,
  "outdated": false,
  "deprecated": false,
  "deprecation_date": null,
  "deprecation_reason": null,
  "disabled": false,
  "disable_date": null,
  "disable_reason": null,
  "post_install_defined": false,
  "service": null,
  "tap_git_head": "aa66a84309b297ea296f7a4b9c424b5c0ec4875c",
  "ruby_source_path": "Formula/wal2json.rb",
  "ruby_source_checksum": {
    "sha256": "97ecd65bd222f6d2228ebb00ac4c28bfa15ca699711284ce589342acc871ae0e"
  },
  "date_added": "2019-10-20T15:28:52+02:00",
  "readme": "[![Coverity Scan Build Status](https://scan.coverity.com/projects/4832/badge.svg)](https://scan.coverity.com/projects/wal2json)\n\nIntroduction\n============\n\n**wal2json** is an output plugin for logical decoding. It means that the plugin have access to tuples produced by INSERT and UPDATE. Also, UPDATE/DELETE old row versions can be accessed depending on the configured replica identity. Changes can be consumed using the streaming protocol (logical replication slots) or by a special SQL API.\n\n**format version 1** produces a JSON object per transaction. All of the new/old tuples are available in the JSON object. Also, there are options to include properties such as transaction timestamp, schema-qualified, data types, and transaction ids.\n\n**format version 2** produces a JSON object per tuple. Optional JSON object for beginning and end of transaction. Also, there are a variety of options to include properties.\n\nBuild and Install\n=================\n\nThis extension is supported on [those platforms](http://www.postgresql.org/docs/current/static/supported-platforms.html) that PostgreSQL is. The installation steps depend on your operating system. [PostgreSQL yum repository](https://yum.postgresql.org) and [PostgreSQL apt repository](https://wiki.postgresql.org/wiki/Apt) provide wal2json packages.\n\nIn Red Hat/CentOS:\n\n```\n$ sudo yum install wal2json14\n```\n\nIn Debian/Ubuntu:\n\n```\n$ sudo apt-get install postgresql-14-wal2json\n```\n\nYou can also keep up with the latest fixes and features cloning the Git repository.\n\n```\n$ git clone https://github.com/eulerto/wal2json.git\n```\n\nUnix based Operating Systems\n----------------------------\n\nBefore installing **wal2json**, you should have PostgreSQL 9.4+ installed (including the header files). If PostgreSQL is not in your search path, add it. If you are using [PostgreSQL yum repository](https://yum.postgresql.org), install `postgresql14-devel` and add `/usr/pgsql-14/bin` to your search path (yum uses `14, 13, 12, 11, 10, 96 or 95`). If you are using [PostgreSQL apt repository](https://wiki.postgresql.org/wiki/Apt), install `postgresql-server-dev-14` and add `/usr/lib/postgresql/14/bin` to your search path. (apt uses `14, 13, 12, 11, 10, 9.6 or 9.5`).\n\nIf you compile PostgreSQL by yourself and install it in `/home/euler/pg14`:\n\n```\n$ tar -zxf wal2json-wal2json_2_5.tar.gz\n$ cd wal2json-wal2json_2_5\n$ export PATH=/home/euler/pg14/bin:$PATH\n$ make\n$ make install\n```\n\nIf you are using [PostgreSQL yum repository](https://yum.postgresql.org):\n\n```\n$ sudo yum install postgresql14-devel\n$ tar -zxf wal2json-wal2json_2_5.tar.gz\n$ cd wal2json-wal2json_2_5\n$ export PATH=/usr/pgsql-14/bin:$PATH\n$ make\n$ make install\n```\n\nIf you are using [PostgreSQL apt repository](https://wiki.postgresql.org/wiki/Apt):\n\n```\n$ sudo apt-get install postgresql-server-dev-14\n$ tar -zxf wal2json-wal2json_2_5.tar.gz\n$ cd wal2json-wal2json_2_5\n$ export PATH=/usr/lib/postgresql/14/bin:$PATH\n$ make\n$ make install\n```\n\nWindows\n-------\n\nThere are several ways to build **wal2json** on Windows. If you are build PostgreSQL too, you can put **wal2json** directory inside contrib, change the contrib Makefile (variable SUBDIRS) and build it following the [Installation from Source Code on Windows](http://www.postgresql.org/docs/current/static/install-windows.html) instructions. However, if you already have PostgreSQL installed, it is also possible to compile **wal2json** out of the tree. Edit `wal2json.vcxproj` file and change `c:\\postgres\\pg103` to the PostgreSQL prefix directory. The next step is to open this project file in MS Visual Studio and compile it. Final step is to copy `wal2json.dll` to the `pg_config --pkglibdir` directory.\n\nConfiguration\n=============\n\npostgresql.conf\n---------------\n\nYou need to set up at least two parameters at postgresql.conf:\n\n```\nwal_level = logical\n#\n# these parameters only need to set in versions 9.4, 9.5 and 9.6\n# default values are ok in version 10 or later\n#\nmax_replication_slots = 10\nmax_wal_senders = 10\n```\n\nAfter changing these parameters, a restart is needed.\n\nParameters\n----------\n\n* `include-xids`: add _xid_ to each changeset. Default is _false_.\n* `include-timestamp`: add _timestamp_ to each changeset. Default is _false_.\n* `include-schemas`: add _schema_ to each change. Default is _true_.\n* `include-types`: add _type_ to each change. Default is _true_.\n* `include-typmod`: add modifier to types that have it (eg. varchar(20) instead of varchar). Default is _true_.\n* `include-type-oids`: add type oids. Default is _false_.\n* `include-domain-data-type`: replace domain name with the underlying data type. Default is _false_.\n* `include-column-positions`: add column position (_pg_attribute.attnum_). Default is _false_.\n* `include-origin`: add origin of a piece of data. Default is _false_.\n* `include-not-null`: add _not null_ information as _columnoptionals_. Default is _false_.\n* `include-default`: add default expression. Default is _false_.\n* `include-pk`: add _primary key_ information as _pk_. Column name and data type is included. Default is _false_.\n* `numeric-data-types-as-string`: use string for numeric data types. JSON specification does not recognize `Infinity` and `NaN` as valid numeric values. There might be [potential interoperability problems](https://datatracker.ietf.org/doc/html/rfc7159#section-6) for double precision numbers. Default is _false_.\n* `pretty-print`: add spaces and indentation to JSON structures. Default is _false_.\n* `write-in-chunks`: write after every change instead of every changeset. Only used when `format-version` is `1`. Default is _false_.\n* `include-lsn`: add _nextlsn_ to each changeset. Default is _false_.\n* `include-transaction`: emit records denoting the start and end of each transaction. Default is _true_.\n* `include-unchanged-toast` (deprecated): Don't use it. It is deprecated.\n* `filter-origins`: exclude changes from the specified origins. Default is empty which means that no origin will be filtered. It is a comma separated value.\n* `filter-tables`: exclude rows from the specified tables. Default is empty which means that no table will be filtered. It is a comma separated value. The tables should be schema-qualified. `*.foo` means table foo in all schemas and `bar.*` means all tables in schema bar. Special characters (space, single quote, comma, period, asterisk) must be escaped with backslash. Schema and table are case-sensitive. Table `\"public\".\"Foo bar\"` should be specified as `public.Foo\\ bar`.\n* `add-tables`: include only rows from the specified tables. Default is all tables from all schemas. It has the same rules from `filter-tables`.\n* `filter-msg-prefixes`: exclude messages if prefix is in the list. Default is empty which means that no message will be filtered. It is a comma separated value.\n* `add-msg-prefixes`: include only messages if prefix is in the list. Default is all prefixes. It is a comma separated value. `wal2json` applies `filter-msg-prefixes` before this parameter.\n* `format-version`: defines which format to use. Default is _1_.\n* `actions`: define which operations will be sent. Default is all actions (insert, update, delete, and truncate). However, if you are using `format-version` 1, truncate is not enabled (backward compatibility).\n\nExamples\n========\n\nThere are two ways to obtain the changes (JSON objects) from **wal2json** plugin: calling functions via SQL or pg_recvlogical.\n\npg_recvlogical\n--------------\n\nBesides the configuration above, it is necessary to configure a replication connection to use pg_recvlogical. A logical replication connection in version 9.4, 9.5, and 9.6 requires `replication` keyword in the database column. Since version 10, logical replication matches a normal entry with a database name or keywords such as `all`.\n\nFirst, add a replication connection rule at pg_hba.conf (9.4, 9.5, and 9.6):\n\n```\nlocal    replication     myuser                     trust\n```\n\nIf you are using version 10 or later:\n\n```\nlocal    mydatabase      myuser                     trust\n```\n\nAlso, set max_wal_senders at postgresql.conf:\n\n```\nmax_wal_senders = 1\n```\n\nA restart is necessary if you changed max_wal_senders.\n\nYou are ready to try **wal2json**. In one terminal:\n\n```\n$ pg_recvlogical -d postgres --slot test_slot --create-slot -P wal2json\n$ pg_recvlogical -d postgres --slot test_slot --start -o pretty-print=1 -o add-msg-prefixes=wal2json -f -\n```\n\nIn another terminal:\n\n```\n$ cat /tmp/example1.sql\nCREATE TABLE table1_with_pk (a SERIAL, b VARCHAR(30), c TIMESTAMP NOT NULL, PRIMARY KEY(a, c));\nCREATE TABLE table1_without_pk (a SERIAL, b NUMERIC(5,2), c TEXT);\n\nBEGIN;\nINSERT INTO table1_with_pk (b, c) VALUES('Backup and Restore', now());\nINSERT INTO table1_with_pk (b, c) VALUES('Tuning', now());\nINSERT INTO table1_with_pk (b, c) VALUES('Replication', now());\nSELECT pg_logical_emit_message(true, 'wal2json', 'this message will be delivered');\nSELECT pg_logical_emit_message(true, 'pgoutput', 'this message will be filtered');\nDELETE FROM table1_with_pk WHERE a < 3;\nSELECT pg_logical_emit_message(false, 'wal2json', 'this non-transactional message will be delivered even if you rollback the transaction');\n\nINSERT INTO table1_without_pk (b, c) VALUES(2.34, 'Tapir');\n-- it is not added to stream because there isn't a pk or a replica identity\nUPDATE table1_without_pk SET c = 'Anta' WHERE c = 'Tapir';\nCOMMIT;\n\nDROP TABLE table1_with_pk;\nDROP TABLE table1_without_pk;\n\n$ psql -At -f /tmp/example1.sql postgres\nCREATE TABLE\nCREATE TABLE\nBEGIN\nINSERT 0 1\nINSERT 0 1\nINSERT 0 1\n3/78BFC828\n3/78BFC880\nDELETE 2\n3/78BFC990\nINSERT 0 1\nUPDATE 1\nCOMMIT\nDROP TABLE\nDROP TABLE\n```\n\nThe output in the first terminal is:\n\n```\n{\n\t\"change\": [\n\t]\n}\n{\n\t\"change\": [\n\t]\n}\n{\n    \"change\": [\n        {\n            \"kind\": \"message\",\n            \"transactional\": false,\n            \"prefix\": \"wal2json\",\n            \"content\": \"this non-transactional message will be delivered even if you rollback the transaction\"\n        }\n    ]\n}\nWARNING:  table \"table1_without_pk\" without primary key or replica identity is nothing\n{\n\t\"change\": [\n\t\t{\n\t\t\t\"kind\": \"insert\",\n\t\t\t\"schema\": \"public\",\n\t\t\t\"table\": \"table1_with_pk\",\n\t\t\t\"columnnames\": [\"a\", \"b\", \"c\"],\n\t\t\t\"columntypes\": [\"integer\", \"character varying(30)\", \"timestamp without time zone\"],\n\t\t\t\"columnvalues\": [1, \"Backup and Restore\", \"2018-03-27 11:58:28.988414\"]\n\t\t}\n\t\t,{\n\t\t\t\"kind\": \"insert\",\n\t\t\t\"schema\": \"public\",\n\t\t\t\"table\": \"table1_with_pk\",\n\t\t\t\"columnnames\": [\"a\", \"b\", \"c\"],\n\t\t\t\"columntypes\": [\"integer\", \"character varying(30)\", \"timestamp without time zone\"],\n\t\t\t\"columnvalues\": [2, \"Tuning\", \"2018-03-27 11:58:28.988414\"]\n\t\t}\n\t\t,{\n\t\t\t\"kind\": \"insert\",\n\t\t\t\"schema\": \"public\",\n\t\t\t\"table\": \"table1_with_pk\",\n\t\t\t\"columnnames\": [\"a\", \"b\", \"c\"],\n\t\t\t\"columntypes\": [\"integer\", \"character varying(30)\", \"timestamp without time zone\"],\n\t\t\t\"columnvalues\": [3, \"Replication\", \"2018-03-27 11:58:28.988414\"]\n\t\t}\n        ,{\n            \"kind\": \"message\",\n            \"transactional\": true,\n            \"prefix\": \"wal2json\",\n            \"content\": \"this message will be delivered\"\n        }\n\t\t,{\n\t\t\t\"kind\": \"delete\",\n\t\t\t\"schema\": \"public\",\n\t\t\t\"table\": \"table1_with_pk\",\n\t\t\t\"oldkeys\": {\n\t\t\t\t\"keynames\": [\"a\", \"c\"],\n\t\t\t\t\"keytypes\": [\"integer\", \"timestamp without time zone\"],\n\t\t\t\t\"keyvalues\": [1, \"2018-03-27 11:58:28.988414\"]\n\t\t\t}\n\t\t}\n\t\t,{\n\t\t\t\"kind\": \"delete\",\n\t\t\t\"schema\": \"public\",\n\t\t\t\"table\": \"table1_with_pk\",\n\t\t\t\"oldkeys\": {\n\t\t\t\t\"keynames\": [\"a\", \"c\"],\n\t\t\t\t\"keytypes\": [\"integer\", \"timestamp without time zone\"],\n\t\t\t\t\"keyvalues\": [2, \"2018-03-27 11:58:28.988414\"]\n\t\t\t}\n\t\t}\n\t\t,{\n\t\t\t\"kind\": \"insert\",\n\t\t\t\"schema\": \"public\",\n\t\t\t\"table\": \"table1_without_pk\",\n\t\t\t\"columnnames\": [\"a\", \"b\", \"c\"],\n\t\t\t\"columntypes\": [\"integer\", \"numeric(5,2)\", \"text\"],\n\t\t\t\"columnvalues\": [1, 2.34, \"Tapir\"]\n\t\t}\n\t]\n}\n{\n    \"change\": [\n    ]\n}\n{\n    \"change\": [\n    ]\n}\n```\n\nDropping the slot in the first terminal:\n\n```\nCtrl+C\n$ pg_recvlogical -d postgres --slot test_slot --drop-slot\n```\n\nSQL functions\n-------------\n\n```\n$ cat /tmp/example2.sql\nCREATE TABLE table2_with_pk (a SERIAL, b VARCHAR(30), c TIMESTAMP NOT NULL, PRIMARY KEY(a, c));\nCREATE TABLE table2_without_pk (a SERIAL, b NUMERIC(5,2), c TEXT);\n\nSELECT 'init' FROM pg_create_logical_replication_slot('test_slot', 'wal2json');\n\nBEGIN;\nINSERT INTO table2_with_pk (b, c) VALUES('Backup and Restore', now());\nINSERT INTO table2_with_pk (b, c) VALUES('Tuning', now());\nINSERT INTO table2_with_pk (b, c) VALUES('Replication', now());\nSELECT pg_logical_emit_message(true, 'wal2json', 'this message will be delivered');\nSELECT pg_logical_emit_message(true, 'pgoutput', 'this message will be filtered');\nDELETE FROM table2_with_pk WHERE a < 3;\nSELECT pg_logical_emit_message(false, 'wal2json', 'this non-transactional message will be delivered even if you rollback the transaction');\n\nINSERT INTO table2_without_pk (b, c) VALUES(2.34, 'Tapir');\n-- it is not added to stream because there isn't a pk or a replica identity\nUPDATE table2_without_pk SET c = 'Anta' WHERE c = 'Tapir';\nCOMMIT;\n\nSELECT data FROM pg_logical_slot_get_changes('test_slot', NULL, NULL, 'pretty-print', '1', 'add-msg-prefixes', 'wal2json');\nSELECT 'stop' FROM pg_drop_replication_slot('test_slot');\n\nDROP TABLE table2_with_pk;\nDROP TABLE table2_without_pk;\n```\n\nThe script above produces the output below:\n\n```\n$ psql -At -f /tmp/example2.sql postgres\nCREATE TABLE\nCREATE TABLE\ninit\nBEGIN\nINSERT 0 1\nINSERT 0 1\nINSERT 0 1\n3/78C2CA50\n3/78C2CAA8\nDELETE 2\n3/78C2CBD8\nINSERT 0 1\nUPDATE 1\nCOMMIT\n{\n    \"change\": [\n        {\n            \"kind\": \"message\",\n            \"transactional\": false,\n            \"prefix\": \"wal2json\",\n            \"content\": \"this non-transactional message will be delivered even if you rollback the transaction\"\n        }\n    ]\n}\npsql:/tmp/example2.sql:17: WARNING:  table \"table2_without_pk\" without primary key or replica identity is nothing\n{\n\t\"change\": [\n\t\t{\n\t\t\t\"kind\": \"insert\",\n\t\t\t\"schema\": \"public\",\n\t\t\t\"table\": \"table2_with_pk\",\n\t\t\t\"columnnames\": [\"a\", \"b\", \"c\"],\n\t\t\t\"columntypes\": [\"integer\", \"character varying(30)\", \"timestamp without time zone\"],\n\t\t\t\"columnvalues\": [1, \"Backup and Restore\", \"2018-03-27 12:05:29.914496\"]\n\t\t}\n\t\t,{\n\t\t\t\"kind\": \"insert\",\n\t\t\t\"schema\": \"public\",\n\t\t\t\"table\": \"table2_with_pk\",\n\t\t\t\"columnnames\": [\"a\", \"b\", \"c\"],\n\t\t\t\"columntypes\": [\"integer\", \"character varying(30)\", \"timestamp without time zone\"],\n\t\t\t\"columnvalues\": [2, \"Tuning\", \"2018-03-27 12:05:29.914496\"]\n\t\t}\n\t\t,{\n\t\t\t\"kind\": \"insert\",\n\t\t\t\"schema\": \"public\",\n\t\t\t\"table\": \"table2_with_pk\",\n\t\t\t\"columnnames\": [\"a\", \"b\", \"c\"],\n\t\t\t\"columntypes\": [\"integer\", \"character varying(30)\", \"timestamp without time zone\"],\n\t\t\t\"columnvalues\": [3, \"Replication\", \"2018-03-27 12:05:29.914496\"]\n\t\t}\n        ,{\n            \"kind\": \"message\",\n            \"transactional\": true,\n            \"prefix\": \"wal2json\",\n            \"content\": \"this message will be delivered\"\n        }\n\t\t,{\n\t\t\t\"kind\": \"delete\",\n\t\t\t\"schema\": \"public\",\n\t\t\t\"table\": \"table2_with_pk\",\n\t\t\t\"oldkeys\": {\n\t\t\t\t\"keynames\": [\"a\", \"c\"],\n\t\t\t\t\"keytypes\": [\"integer\", \"timestamp without time zone\"],\n\t\t\t\t\"keyvalues\": [1, \"2018-03-27 12:05:29.914496\"]\n\t\t\t}\n\t\t}\n\t\t,{\n\t\t\t\"kind\": \"delete\",\n\t\t\t\"schema\": \"public\",\n\t\t\t\"table\": \"table2_with_pk\",\n\t\t\t\"oldkeys\": {\n\t\t\t\t\"keynames\": [\"a\", \"c\"],\n\t\t\t\t\"keytypes\": [\"integer\", \"timestamp without time zone\"],\n\t\t\t\t\"keyvalues\": [2, \"2018-03-27 12:05:29.914496\"]\n\t\t\t}\n\t\t}\n\t\t,{\n\t\t\t\"kind\": \"insert\",\n\t\t\t\"schema\": \"public\",\n\t\t\t\"table\": \"table2_without_pk\",\n\t\t\t\"columnnames\": [\"a\", \"b\", \"c\"],\n\t\t\t\"columntypes\": [\"integer\", \"numeric(5,2)\", \"text\"],\n\t\t\t\"columnvalues\": [1, 2.34, \"Tapir\"]\n\t\t}\n\t]\n}\nstop\nDROP TABLE\nDROP TABLE\n```\n\nLet's repeat the same example with `format-version` 2:\n\n```\n$ cat /tmp/example3.sql\nCREATE TABLE table3_with_pk (a SERIAL, b VARCHAR(30), c TIMESTAMP NOT NULL, PRIMARY KEY(a, c));\nCREATE TABLE table3_without_pk (a SERIAL, b NUMERIC(5,2), c TEXT);\n\nSELECT 'init' FROM pg_create_logical_replication_slot('test_slot', 'wal2json');\n\nBEGIN;\nINSERT INTO table3_with_pk (b, c) VALUES('Backup and Restore', now());\nINSERT INTO table3_with_pk (b, c) VALUES('Tuning', now());\nINSERT INTO table3_with_pk (b, c) VALUES('Replication', now());\nSELECT pg_logical_emit_message(true, 'wal2json', 'this message will be delivered');\nSELECT pg_logical_emit_message(true, 'pgoutput', 'this message will be filtered');\nDELETE FROM table3_with_pk WHERE a < 3;\nSELECT pg_logical_emit_message(false, 'wal2json', 'this non-transactional message will be delivered even if you rollback the transaction');\n\nINSERT INTO table3_without_pk (b, c) VALUES(2.34, 'Tapir');\n-- it is not added to stream because there isn't a pk or a replica identity\nUPDATE table3_without_pk SET c = 'Anta' WHERE c = 'Tapir';\nCOMMIT;\n\nSELECT data FROM pg_logical_slot_get_changes('test_slot', NULL, NULL, 'format-version', '2', 'add-msg-prefixes', 'wal2json');\nSELECT 'stop' FROM pg_drop_replication_slot('test_slot');\n\nDROP TABLE table3_with_pk;\nDROP TABLE table3_without_pk;\n```\n\nThe script above produces the output below:\n\n```\n$ psql -At -f /tmp/example3.sql postgres\nCREATE TABLE\nCREATE TABLE\ninit\nBEGIN\nINSERT 0 1\nINSERT 0 1\nINSERT 0 1\n3/78CB8F30\n3/78CB8F88\nDELETE 2\n3/78CB90B8\nINSERT 0 1\nUPDATE 1\nCOMMIT\npsql:/tmp/example3.sql:20: WARNING:  no tuple identifier for UPDATE in table \"public\".\"table3_without_pk\"\n{\"action\":\"M\",\"transactional\":false,\"prefix\":\"wal2json\",\"content\":\"this non-transactional message will be delivered even if you rollback the transaction\"}\n{\"action\":\"B\"}\n{\"action\":\"I\",\"schema\":\"public\",\"table\":\"table3_with_pk\",\"columns\":[{\"name\":\"a\",\"type\":\"integer\",\"value\":1},{\"name\":\"b\",\"type\":\"character varying(30)\",\"value\":\"Backup and Restore\"},{\"name\":\"c\",\"type\":\"timestamp without time zone\",\"value\":\"2019-12-29 04:58:34.806671\"}]}\n{\"action\":\"I\",\"schema\":\"public\",\"table\":\"table3_with_pk\",\"columns\":[{\"name\":\"a\",\"type\":\"integer\",\"value\":2},{\"name\":\"b\",\"type\":\"character varying(30)\",\"value\":\"Tuning\"},{\"name\":\"c\",\"type\":\"timestamp without time zone\",\"value\":\"2019-12-29 04:58:34.806671\"}]}\n{\"action\":\"I\",\"schema\":\"public\",\"table\":\"table3_with_pk\",\"columns\":[{\"name\":\"a\",\"type\":\"integer\",\"value\":3},{\"name\":\"b\",\"type\":\"character varying(30)\",\"value\":\"Replication\"},{\"name\":\"c\",\"type\":\"timestamp without time zone\",\"value\":\"2019-12-29 04:58:34.806671\"}]}\n{\"action\":\"M\",\"transactional\":true,\"prefix\":\"wal2json\",\"content\":\"this message will be delivered\"}\n{\"action\":\"D\",\"schema\":\"public\",\"table\":\"table3_with_pk\",\"identity\":[{\"name\":\"a\",\"type\":\"integer\",\"value\":1},{\"name\":\"c\",\"type\":\"timestamp without time zone\",\"value\":\"2019-12-29 04:58:34.806671\"}]}\n{\"action\":\"D\",\"schema\":\"public\",\"table\":\"table3_with_pk\",\"identity\":[{\"name\":\"a\",\"type\":\"integer\",\"value\":2},{\"name\":\"c\",\"type\":\"timestamp without time zone\",\"value\":\"2019-12-29 04:58:34.806671\"}]}\n{\"action\":\"I\",\"schema\":\"public\",\"table\":\"table3_without_pk\",\"columns\":[{\"name\":\"a\",\"type\":\"integer\",\"value\":1},{\"name\":\"b\",\"type\":\"numeric(5,2)\",\"value\":2.34},{\"name\":\"c\",\"type\":\"text\",\"value\":\"Tapir\"}]}\n{\"action\":\"C\"}\nstop\nDROP TABLE\nDROP TABLE\n```\n\nLicense\n=======\n\n> Copyright (c) 2013-2022, Euler Taveira de Oliveira\n> All rights reserved.\n\n> Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:\n\n> Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.\n\n> Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.\n\n> Neither the name of the Euler Taveira de Oliveira nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.\n\n> THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE."
}
