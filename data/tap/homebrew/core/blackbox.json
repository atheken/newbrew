{
  "name": "blackbox",
  "full_name": "blackbox",
  "tap": "homebrew/core",
  "oldname": null,
  "oldnames": [],
  "aliases": [],
  "versioned_formulae": [],
  "desc": "Safely store secrets in Git/Mercurial/Subversion",
  "license": "MIT",
  "homepage": "https://github.com/StackExchange/blackbox",
  "versions": {
    "stable": "1.20220610",
    "head": null,
    "bottle": true
  },
  "urls": {
    "stable": {
      "url": "https://github.com/StackExchange/blackbox/archive/v1.20220610.tar.gz",
      "tag": null,
      "revision": null,
      "checksum": "f1efcca6680159f244eb44fdb78e92b521760b875fa5a36e4c433b93ed0f87c1"
    }
  },
  "revision": 0,
  "version_scheme": 1,
  "bottle": {
    "stable": {
      "rebuild": 0,
      "root_url": "https://ghcr.io/v2/homebrew/core",
      "files": {
        "all": {
          "cellar": ":any_skip_relocation",
          "url": "https://ghcr.io/v2/homebrew/core/blackbox/blobs/sha256:419360782c976255a478975376c6a504085ec82c56e16938a76f7a0fd322b2b6",
          "sha256": "419360782c976255a478975376c6a504085ec82c56e16938a76f7a0fd322b2b6"
        }
      }
    }
  },
  "keg_only": false,
  "keg_only_reason": null,
  "options": [],
  "build_dependencies": [],
  "dependencies": [
    "gnupg"
  ],
  "test_dependencies": [],
  "recommended_dependencies": [],
  "optional_dependencies": [],
  "uses_from_macos": [],
  "uses_from_macos_bounds": [],
  "requirements": [],
  "conflicts_with": [],
  "conflicts_with_reasons": [],
  "link_overwrite": [],
  "caveats": null,
  "installed": [],
  "linked_keg": null,
  "pinned": false,
  "outdated": false,
  "deprecated": false,
  "deprecation_date": null,
  "deprecation_reason": null,
  "disabled": false,
  "disable_date": null,
  "disable_reason": null,
  "post_install_defined": false,
  "service": null,
  "tap_git_head": "2706c66e8def3eeba4d9bf1adf66221c8ad70701",
  "ruby_source_path": "Formula/blackbox.rb",
  "ruby_source_checksum": {
    "sha256": "865632f3549818f40a63dcc75b27cfbcdc03f545ef6eef31dd5b1657cdd26a72"
  },
  "date_added": "2012-02-18T14:33:49-08:00",
  "readme": "BlackBox [![CircleCI](https://circleci.com/gh/StackExchange/blackbox.svg?style=shield)](https://circleci.com/gh/StackExchange/workflows/blackbox) [![Build Status](https://github.com/StackExchange/blackbox/workflows/build/badge.svg)](https://github.com/StackExchange/blackbox/actions?query=workflow%3Abuild+branch%3Amaster)\n========\n\nSafely store secrets in a VCS repo (i.e. Git, Mercurial, Subversion or Perforce). These commands make it easy for you to Gnu Privacy Guard (GPG) encrypt specific files in a repo so they are \"encrypted at rest\" in your repository. However, the scripts make it easy to decrypt them when you need to view or edit them, and decrypt them for use in production. Originally written for Puppet, BlackBox now works with any Git or Mercurial repository.\n\n\nWARNING: The goal of this project is to be a simple wrapper around `gpg` so you and your coworkers don't have to remember its all those inscrutable and confusing flags.  It is *not* intended to be a sophisticated encryption system that solves all problems or supports a large numbers of files.  The ideal use-case is to keep secrets in a secure service such as Conjur, AWS KMS, Azure Key Vault or GCP KMS; then use Blackbox for safely storing the API keys needed to access that system. That way you are encrypting a single, tiny, file. Feature-requests for anything more will be rejected; do not expect or even request \"enterprise features\". If this disappoints you, please consider a competiting project such as https://www.agwa.name/projects/git-crypt\n\nA slide presentation (about an older release) [is on SlideShare](http://www.slideshare.net/TomLimoncelli/the-blackbox-project-sfae).\n\nJoin our mailing list: [https://groups.google.com/d/forum/blackbox-project](https://groups.google.com/d/forum/blackbox-project)\n\n## What blackbox is NOT:\n\n\nTable of Contents\n=================\n\n- [BlackBox](#blackbox)\n- [Table of Contents](#table-of-contents)\n- [Overview](#overview)\n- [Why is this important?](#why-is-this-important)\n- [Installation Instructions](#installation-instructions)\n- [Commands](#commands)\n- [Compatibility](#compatibility)\n- [How is the encryption done?](#how-is-the-encryption-done)\n- [What does this look like to the typical user?](#what-does-this-look-like-to-the-typical-user)\n- Configuration Management\n  - [How to use the secrets with Ansible?](#how-to-use-the-secrets-with-ansible)\n  - [How to use the secrets with Puppet?](#how-to-use-the-secrets-with-puppet)\n    - [Entire files](#entire-files)\n    - [Small strings](#small-strings)\n- File Management\n  - [How to enroll a new file into the system?](#how-to-enroll-a-new-file-into-the-system)\n  - [How to remove a file from the system?](#how-to-remove-a-file-from-the-system)\n- User Management\n  - [How to indoctrinate a new user into the system?](#how-to-indoctrinate-a-new-user-into-the-system)\n  - [How to remove a user from the system?](#how-to-remove-a-user-from-the-system)\n- Repo Management\n  - [Enabling BlackBox For a Repo](#enabling-blackbox-for-a-repo)\n- [Set up automated users or &ldquo;role accounts&rdquo;](#set-up-automated-users-or-role-accounts)\n- [Replacing expired keys](#replacing-expired-keys)\n- [Some common errors](#some-common-errors)\n- [Using BlackBox on Windows](#using-blackbox-on-windows)\n- [Using BlackBox without a repo](#using-blackbox-without-a-repo)\n- [Some Subversion gotchas](#some-subversion-gotchas)\n- [Using Blackbox when gpg2 is installed next to gpg](#using-blackbox-when-gpg2-is-installed-next-to-gpg)\n- [How to submit bugs or ask questions?](#how-to-submit-bugs-or-ask-questions)\n- [Developer Info](#developer-info)\n- [Alternatives](#alternatives)\n- [License](#license)\n\nOverview\n========\n\nSuppose you have a VCS repository (i.e. a Git or Mercurial repo) and certain files contain secrets such as passwords or SSL private keys. Often people just store such files \"and hope that nobody finds them in the repo\". That's not safe.\n\nWith BlackBox, those files are stored encrypted using GPG. Access to the VCS repo without also having the right GPG keys makes it worthless to have the files. As long as you keep your GPG keys safe, you don't have to worry about storing your VCS repo on an untrusted server. Heck, even if you trust your server, now you don't have to trust the people that do backups of that server, or the people that handle the backup tapes!\n\nRather than one GPG passphrase for all the files, each person with access has their own GPG keys in the system. Any file can be decrypted by anyone with their GPG key. This way, if one person leaves the company, you don't have to communicate a new password to everyone with access. Simply disable the one key that should no longer have access. The process for doing this is as easy as running 2 commands (1 to disable their key, 1 to re-encrypt all files.)\n\nAutomated processes often need access to all the decrypted files. This is easy too. For example, suppose Git is being used for Puppet files. The master needs access to the decrypted version of all the files. Simply set up a GPG key for the Puppet master (or the role account that pushes new files to the Puppet master) and have that user run `blackbox_postdeploy` after any files are updated.\n\nGetting started\n---------------\n\n1. If you don't have a GPG key, set it up using instructions such as:\n[Set up GPG key](https://help.github.com/articles/generating-a-new-gpg-key/). \\\nNow you are ready to go.\n\n1. `cd` into a Git, Mercurial, Subversion or Perforce repository and run `blackbox_initialize`.\n\n1. If a file is to be encrypted, run `blackbox_register_new_file` and you are done.\n\n1. Add and remove keys with `blackbox_addadmin` and `blackbox_removeadmin`.\n\n1. To view and/or edit a file, run `blackbox_edit`;\nthis will decrypt the file and open with whatever is specified by\nyour $EDITOR environment variable. \\\nWhen you close the editor the\nfile will automatically be encrypted again and the temporary plaintext\nfile will be shredded. \\\nIf you need to leave the file decrypted while\nyou update you can use the`blackbox_edit_start` to decrypt the file\nand `blackbox_edit_end` when you want to \"put it back in the box.\"\n\nWhy is this important?\n======================\n\nOBVIOUSLY we don't want secret things like SSL private keys and passwords to be leaked.\n\nNOT SO OBVIOUSLY when we store \"secrets\" in a VCS repo like Git or Mercurial, suddenly we are less able to share our code with other people. Communication between subteams of an organization is hurt. You can't collaborate as well. Either you find yourself emailing individual files around (yuck!), making a special repo with just the files needed by your collaborators (yuck!!), or just deciding that collaboration isn't worth all that effort (yuck!!!).\n\nThe ability to be open and transparent about our code, with the exception of a few specific files, is key to the kind of collaboration that DevOps and modern IT practitioners need to do.\n\nInstallation Instructions\n=========================\n\n- *The hard way (manual)*: Copy all the files in \"bin\" to your \"bin\".\n- *The hard way (automatic)*: `make copy-install` will copy the bin files into $PREFIX/bin, default is /usr/local (uninstall with `make copy-uninstall`).\n- *The symlinks way*: `make symlinks-install` will make symlinks of the bin files into $PREFIX/bin, default is /usr/local (uninstall with `make copy-uninstall`) (useful when doing development)\n- *The MacPorts Way*: `sudo port install vcs_blackbox`\n- *The Homebrew Way*: `brew install blackbox`\n- *The RPM way*: Check out the repo and make an RPM via `make packages-rpm`; now you can distribute the RPM via local methods. (Requires [fpm](https://github.com/jordansissel/fpm).)\n- *The Debian/Ubuntu way*: Check out the repo and make a DEB via `make packages-deb`; now you can distribute the DEB via local methods. (Requires [fpm](https://github.com/jordansissel/fpm).)\n- *The Antigen Way*: Add `antigen bundle StackExchange/blackbox` to your .zshrc\n- *The Zgenom Way*: Add `zgenom load StackExchange/blackbox` to your .zshrc where you're loading your other plugins.\n- *The Nix Way*: `nix-shell -p blackbox`\n- *The Pkgsrc Way*: `pkgin in scm-blackbox`\n\nCommands\n========\n\n| Name:                               | Description:                                                            |\n|-------------------------------------|-------------------------------------------------------------------------|\n| `blackbox_edit <file>`              | Decrypt, run $EDITOR, re-encrypt a file                                 |\n| `blackbox_edit_start <file>`        | Decrypt a file so it can be updated                                     |\n| `blackbox_edit_end <file>`          | Encrypt a file after blackbox_edit_start was used                       |\n| `blackbox_cat <file>`               | Decrypt and view the contents of a file                                 |\n| `blackbox_view <file>`              | Like blackbox_cat but pipes to `less` or $PAGER                         |\n| `blackbox_diff`                     | Diff decrypted files against their original crypted version             |\n| `blackbox_initialize`               | Enable blackbox for a GIT or HG repo                                    |\n| `blackbox_register_new_file <file>` | Encrypt a file for the first time                                       |\n| `blackbox_deregister_file <file>`   | Remove a file from blackbox                                             |\n| `blackbox_list_files`               | List the files maintained by blackbox                                   |\n| `blackbox_list_admins`              | List admins currently authorized for blackbox                           |\n| `blackbox_decrypt_file <file>`      | Decrypt a file                                                          |\n| `blackbox_decrypt_all_files`        | Decrypt all managed files (INTERACTIVE)                                 |\n| `blackbox_postdeploy`               | Decrypt all managed files (batch)                                       |\n| `blackbox_addadmin <gpg-key>`       | Add someone to the list of people that can encrypt/decrypt secrets      |\n| `blackbox_removeadmin <gpg-key>`    | Remove someone from the list of people that can encrypt/decrypt secrets |\n| `blackbox_shred_all_files`          | Safely delete any decrypted files                                       |\n| `blackbox_update_all_files`         | Decrypt then re-encrypt all files. Useful after keys are changed        |\n| `blackbox_whatsnew <file>`          | show what has changed in the last commit for a given file               |\n\nCompatibility\n=============\n\nBlackBox automatically determines which VCS you are using and does the right thing. It has a plug-in architecture to make it easy to extend to work with other systems. It has been tested to work with many operating systems.\n\n- Version Control systems\n  - `git` -- The Git\n  - `hg` -- Mercurial\n  - `svn` -- SubVersion (Thanks, Ben Drasin!)\n  - `p4` -- Perforce\n  - none -- The files can be decrypted outside of a repo if the `.blackbox` directory is intact\n- Operating system\n  - CentOS / RedHat\n  - MacOS X\n  - Cygwin (Thanks, Ben Drasin!) **See Note Below**\n  - MinGW (git bash on windows) **See Note Below**\n  - NetBSD\n  - SmartOS\n\nTo add or fix support for a VCS system, look for code at the end of `bin/_blackbox_common.sh`\n\nTo add or fix support for a new operating system, look for the case statements in `bin/_blackbox_common.sh` and `bin/_stack_lib.sh` and maybe `tools/confidence_test.sh`\n\nUsing BlackBox on Windows\n=========================\n\nBlackBox can be used with Cygwin, MinGW or WSL2.\n\n### Protect the line endings\n\nBlackBox assumes that `blackbox-admins.txt` and `blackbox-files.txt` will have\nLF line endings. Windows users should be careful to configure Git or other systems\nto not convert or \"fix\" those files.\n\nIf you use Git, add the following lines to your `.gitattributes` file:\n\n    **/blackbox-admins.txt text eol=lf\n    **/blackbox-files.txt text eol=lf\n\nThe latest version of `blackbox_initialize` will create a `.gitattributes` file in the `$BLACKBOXDATA`\ndirectory (usually `.blackbox`) for you.\n\n### Cygwin\n\nCygwin support requires the following packages:\n\nNormal operation:\n\n- gnupg\n- git or mercurial or subversion or perforce (as appropriate)\n\nDevelopment (if you will be adding code and want to run the confidence test)\n\n- procps\n- make\n- git (the confidence test currently only tests git)\n\n### MinGW\n\nMinGW (comes with Git for Windows) support requires the following:\n\nNormal operation:\n\n- [Git for Windows](https://git-scm.com/) (not tested with Mercurial)\n  - Git Bash MINTTY returns a MinGW console.  So when you install make sure you pick `MINTTY` instead of windows console.  You'll be executing blackbox from the Git Bash prompt.\n  - You need at least version 2.8.1 of Git for Windows.\n- [GnuWin32](https://sourceforge.net/projects/getgnuwin32/files/) - needed for various tools not least of which is mktemp which is used by blackbox\n  - after downloading the install just provides you with some batch files.  Because of prior issues at sourceforge and to make sure you get the latest version of each package the batch files handle the brunt of the work of getting the correct packages and installing them for you.\n  - from a **windows command prompt** run `download.bat`  once it has completed run `install.bat` then add the path for those tools to your PATH (ex: `PATH=%PATH%;c:\\GnuWin32\\bin`)\n\nDevelopment:\n\n- unknown (if you develop Blackbox under MinGW, please let us know if any additional packages are required to run `make test`)\n\n### WSL2\n\nIf you get the following error in WSL2, you can try to setup your environment with the following instructions (Tested with Ubuntu 22.04 on WSL2):\n\n- Install [Gpg4win](https://www.gpg4win.org/) (Tested with version 4.1.0)\n- Import your private key in Gpg4win (you can use Kleopatra on your Windows host if you wish).\n- Edit the file `~/.gnupg/gpg-agent.conf` on WSL and add the following line: `pinentry-program \"/mnt/c/Program Files (x86)/GnuPG/bin/pinentry-basic.exe\"`\n- Restart gpg agent on your linux system: `gpg-connect-agent reloadagent /bye`\n\nHow is the encryption done?\n===========================\n\nGPG has many different ways to encrypt a file. BlackBox uses the mode that lets you specify a list of keys that can decrypt the message.\n\nIf you have 5 people (\"admins\") that should be able to access the secrets, each creates a GPG key and adds their public key to the keychain. The GPG command used to encrypt the file lists all 5 key names, and therefore any 1 key can decrypt the file.\n\nTo remove someone's access, remove that admin's key name (i.e. email address) from the list of admins and re-encrypt all the files. They can still read the .gpg file (assuming they have access to the repository) but they can't decrypt it any more.\n\n*What if they kept a copy of the old repo before you removed access?* Yes, they can decrypt old versions of the file. This is why when an admin leaves the team, you should change all your passwords, SSL certs, and so on. You should have been doing that before BlackBox, right?\n\n*Why don't you use symmetric keys?* In other words, why mess with all this GPG key stuff and instead why don't we just encrypt all the files with a single passphrase. Yes, GPG supports that, but then we are managing a shared password, which is fraught with problems. If someone \"leaves the team\" we would have to communicate to everyone a new password. Now we just have to remove their key. This scales better.\n\n*How do automated processes decrypt without asking for a password?* GPG requires a passphrase on a private key. However, it permits the creation of subkeys that have no passphrase. For automated processes, create a subkey that is only stored on the machine that needs to decrypt the files. For example, at Stack Exchange, when our Continuous Integration (CI) system pushes a code change to our Puppet masters, they run `blackbox_postdeploy` to decrypt all the files. The user that runs this code has a subkey that doesn't require a passphrase. Since we have many masters, each has its own key. And, yes, this means our Puppet Masters have to be very secure. However, they were already secure because, like, dude... if you can break into someone's puppet master you own their network.\n\n*If you use Puppet, why didn't you just use hiera-eyaml?* There are 4 reasons:\n\n1. This works with any Git or Mercurial repo, even if you aren't using Puppet.\n2. hiera-eyaml decrypts \"on demand\" which means your Puppet Master now uses a lot of CPU to decrypt keys every time it is contacted. It slows down your master, which, in my case, is already slow enough.\n3. This works with binary files, without having to ASCIIify them and paste them into a YAML file. Have you tried to do this with a cert that is 10K long and changes every few weeks? Ick.\n4. hiera-eyaml didn't exist when I wrote this.\n\nWhat does this look like to the typical user?\n=============================================\n\n- If you need to, start the GPG Agent: `eval $(gpg-agent --daemon)`\n- Decrypt the file so it is editable: `blackbox_edit_start FILENAME`\n- (You will need to enter your GPG passphrase.)\n- Edit FILENAME as you desire: `vim FILENAME`\n- Re-encrypt the file: `blackbox_edit_end FILENAME`\n- Commit the changes. `git commit -a` or `hg commit`\n\nWait... it can be even easier than that! Run `blackbox_edit FILENAME`, and it'll decrypt the file in a temp file and call `$EDITOR` on it, re-encrypting again after the editor is closed.\n\nHow to use the secrets with Ansible?\n===================================\n\nAnsible Vault provides functionality for encrypting both entire files and strings stored within files; however,\nkeeping track of the password(s) required for decryption is not handled by this module.\n\nInstead one must specify a password file when running the playbook.\n\nAnsible example for password file: `my_secret_password.txt.gpg`\n\n```\nansible-playbook --vault-password-file my_secret_password.txt site.yml\n```\n\nAlternatively, one can specify this in the `ANSIBLE_VAULT_PASSWORD_FILE` environment variable.\n\nHow to use the secrets with Puppet?\n===================================\n\n### Entire files:\n\nEntire files, such as SSL certs and private keys, are treated just like regular files. You decrypt them any time you push a new release to the puppet master.\n\nPuppet example for an encrypted file: `secret_file.key.gpg`\n\n```\nfile { '/etc/my_little_secret.key':\n    ensure  => 'file',\n    owner   => 'root',\n    group   => 'puppet',\n    mode    => '0760',\n    source  => \"puppet:///modules/${module_name}/secret_file.key\",\n}\n```\n\n### Small strings:\n\nSmall strings, such as passwords and API keys, are stored in a hiera yaml file, which you encrypt with `blackbox_register_new_file`. For example, we use a file called `blackbox.yaml`. You can access them using the hiera() function.\n\n*Setup:* Configure `hiera.yaml` by adding \"blackbox\" to the search hierarchy:\n\n```\n:hierarchy:\n  - ...\n  - blackbox\n  - ...\n```\n\nIn blackbox.yaml specify:\n\n```\n---\nmodule::test_password: \"my secret password\"\n```\n\nIn your Puppet Code, access the password as you would any hiera data:\n\n```\n$the_password = hiera('module::test_password', 'fail')\n\nfile {'/tmp/debug-blackbox.txt':\n    content => $the_password,\n    owner   => 'root',\n    group   => 'root',\n    mode    => '0600',\n}\n```\n\nThe variable `$the_password` will contain \"my secret password\" and can be used anywhere strings are used.\n\nHow to enroll a new file into the system?\n=========================================\n\n- If you need to, start the GPG Agent: `eval $(gpg-agent --daemon)`\n- Add the file to the system:\n\n```\nblackbox_register_new_file path/to/file.name.key\n```\n\nMultiple file names can be specified on the command line:\n\nExample 1: Register 2 files:\n\n```\nblackbox_register_new_file file1.txt file2.txt\n```\n\nExample 2: Register all the files in `$DIR`:\n\n```\nfind $DIR -type f -not -name '*.gpg' -print0 | xargs -0 blackbox_register_new_file\n```\n\nHow to remove a file from the system?\n=====================================\n\nThis happens quite rarely, but we've got it covered:\n\n```\nblackbox_deregister_file path/to/file.name.key\n```\n\nHow to indoctrinate a new user into the system?\n===============================================\n\nFYI: Your repo may use `keyrings/live` instead of `.blackbox`. See \"Where is the configuration stored?\"\n\n`.blackbox/blackbox-admins.txt` is a file that lists which users are able to decrypt files. (More pedantically, it is a list of the GnuPG key names that the file is encrypted for.)\n\nTo join the list of people that can edit the file requires three steps; You create a GPG key and add it to the key ring. Then, someone that already has access adds you to the system. Lastly, you should test your access.\n\n### Step 1: NEW USER creates a GPG key pair on a secure machine and adds to public keychain.\n\nIf you don't already have a GPG key, here's how to generate one:\n\n```\ngpg --gen-key\n```\n\nWARNING: New versions of GPG generate keys which are not understood by\nold versions of GPG.  If you generate a key with a new version of GPG,\nthis will cause problems for users of older versions of GPG.\nTherefore it is recommended that you either assure that everyone using\nBlackbox have the exact same version of GPG, or generate GPG keys\nusing a version of GPG as old as the oldest version of GPG used by\neveryone using Blackbox.\n\nPick defaults for encryption settings, 0 expiration. Pick a VERY GOOD passphrase. Store a backup of the private key someplace secure. For example, keep the backup copy on a USB drive that is locked in safe.  Or, at least put it on a secure machine with little or no internet access, full-disk-encryption, etc. Your employer probably has rules about how to store such things.\n\nFYI: If generating the key is slow, this is usually because the system\nisn't generating enough entropy.  Tip: Open another window on that\nmachine and run this command: `ls -R /`\n\nNow that you have a GPG key, add yourself as an admin:\n\n```\nblackbox_addadmin KEYNAME\n```\n\n...where \"KEYNAME\" is the email address listed in the gpg key you created previously. For example:\n\n```\nblackbox_addadmin tal@example.com\n```\n\nWhen the command completes successfully, instructions on how to commit these changes will be output. Run the command as given to commit the changes. It will look like this:\n\n```\ngit commit -m'NEW ADMIN: tal@example.com' .blackbox/pubring.gpg .blackbox/trustdb.gpg .blackbox/blackbox-admins.txt\n```\n\nThen push it to the repo:\n\n```\ngit push\n\nor\n\nht push\n\n(or whatever is appropriate)\n```\n\nNOTE: Creating a Role Account? If you are adding the pubring.gpg of a role account, you can specify the directory where the pubring.gpg file can be found as a 2nd parameter: `blackbox_addadmin puppetmaster@puppet-master-1.example.com /path/to/the/dir`\n\n### Step 2: EXISTING ADMIN adds new user to the system.\n\nAsk someone that already has access to re-encrypt the data files. This gives you access. They simply decrypt and re-encrypt the data without making any changes.\n\nPre-check: Verify the new keys look good.\n\n```\ngit pull    # Or whatever is required for your system\ngpg --homedir=.blackbox --list-keys\n```\n\nFor example, examine the key name (email address) to make sure it conforms to corporate standards.\n\nImport the keychain into your personal keychain and reencrypt:\n\n```\ngpg --import .blackbox/pubring.gpg\nblackbox_update_all_files\n```\n\nPush the re-encrypted files:\n\n```\ngit commit -a\ngit push\n\nor\n\nhg commit\nhg push\n```\n\n### Step 3: NEW USER tests.\n\nMake sure you can decrypt a file. (Suggestion: Keep a dummy file in VCS just for new people to practice on.)\n\nHow to remove a user from the system?\n=====================================\n\nSimply run `blackbox_removeadmin` with their keyname then re-encrypt:\n\nExample:\n\n```\nblackbox_removeadmin olduser@example.com\nblackbox_update_all_files\n```\n\nWhen the command completes, you will be given a reminder to check in the change and push it.\n\nNote that their keys will still be in the key ring, but they will go unused. If you'd like to clean up the keyring, use the normal GPG commands and check in the file.\n\nFYI: Your repo may use `keyrings/live` instead of `.blackbox`. See \"Where is the configuration stored?\"\n\n```\ngpg --homedir=.blackbox --list-keys\ngpg --homedir=.blackbox --delete-key olduser@example.com\ngit commit -m'Cleaned olduser@example.com from keyring'  .blackbox/*\n```\n\nFYI: Your repo may use `keyrings/live` instead of `.blackbox`. See \"Where is the configuration stored?\"\n\nThe key ring only has public keys. There are no secret keys to delete.\n\nRemember that this person did have access to all the secrets at one time. They could have made a copy. Therefore, to be completely secure, you should change all passwords, generate new SSL keys, and so on just like when anyone that had privileged access leaves an organization.\n\nWhere is the configuration stored? .blackbox vs. keyrings/live\n==============================================================\n\nBlackbox stores its configuration data in the `.blackbox` subdirectory.  Older\nrepos use `keyrings/live`.  For backwards compatibility either will work.\n\nAll documentation refers to `.blackbox`.\n\nYou can convert an old repo by simply renaming the directory:\n\n```\nmv keyrings/live .blackbox\nrmdir keyrings\n```\n\nThere is no technical reason to convert old repos except that it is less\nconfusing to users.\n\nThis change was made in commit 60e782a0, release v1.20180615.\n\nThe details:\n\n- First Blackbox checks `$BLACKBOXDATA`. If this environment variable is set, this is the directory that will be used. If it lists a directory that does not exist, Blackbox will print an error and exit.\n- If `$BLACKBOXDATA` is not set: (which is the typical use case)\n  - Blackbox will first try `keyrings/live` and use it if it exists.\n  - Otherwise the default `.blackbox` will be used.  If `.blackbox` does not exist, Blackbox will print an error and exit.\n\n\nEnabling BlackBox For a Repo\n============================\n\nOverview:\n\nTo add \"blackbox\" to a git or mercurial repo, you'll need to do the following:\n\n1. Run the initialize script. This adds a few files to your repo in a directory called \".blackbox\".\n2. For the first user, create a GPG key and add it to the key ring.\n3. Encrypt the files you want to be \"secret\".\n4. For any automated user (one that must be able to decrypt without a passphrase), create a GPG key and create a subkey with an empty passphrase.\n\nFYI: Your repo may use `keyrings/live` instead of `.blackbox`. See \"Where is the configuration stored?\"\n\n### Run the initialize script.\n\nYou'll want to include blackbox's \"bin\" directory in your PATH:\n\n```\nexport PATH=$PATH:/the/path/to/blackbox/bin\nblackbox_initialize\n```\n\nIf you're using antigen, adding `antigen bundle StackExchange/blackbox` to your .zshrc will download this repository and add it to your $PATH.\n\n### For the first user, create a GPG key and add it to the key ring.\n\nFollow the instructions for \"[How to indoctrinate a new user into the system?](#how-to-indoctrinate-a-new-user-into-the-system)\". Only do Step 1.\n\nOnce that is done, is a good idea to test the system by making sure a file can be added to the system (see \"How to enroll a new file into the system?\"), and a different user can decrypt the file.\n\nMake a new file and register it:\n\n```\nrm -f foo.txt.gpg foo.txt\necho This is a test. >foo.txt\nblackbox_register_new_file foo.txt\n```\n\nDecrypt it:\n\n```\nblackbox_edit_start foo.txt.gpg\ncat foo.txt\necho This is the new file contents. >foo.txt\n```\n\nRe-encrypt it:\n\n```\nblackbox_edit_end foo.txt.gpg\nls -l foo.txt*\n```\n\nYou should only see `foo.txt.gpg` as `foo.txt` should be gone.\n\nThe next step is to commit `foo.txt.gpg` and make sure another user can check out, view, and change the contents of the file. That is left as an exercise for the reader. If you are feel like taking a risk, don't commit `foo.txt.gpg` and delete it instead.\n\nSet up automated users or \"role accounts\"\n=========================================\n\ni.e. This is how a Puppet Master can have access to the unencrypted data.\n\nFYI: Your repo may use `keyrings/live` instead of `.blackbox`. See \"Where is the configuration stored?\"\n\nAn automated user (a \"role account\") is one that that must be able to decrypt without a passphrase. In general you'll want to do this for the user that pulls the files from the repo to the master. This may be automated with Jenkins CI or other CI system.\n\nGPG keys have to have a passphrase. However, passphrases are optional on subkeys. Therefore, we will create a key with a passphrase then create a subkey without a passphrase. Since the subkey is very powerful, it should be created on a very secure machine.\n\nThere's another catch. The role account probably can't check files into Git/Mercurial. It probably only has read-only access to the repo. That's a good security policy. This means that the role account can't be used to upload the subkey public bits into the repo.\n\nTherefore, we will create the key/subkey on a secure machine as yourself. From there we can commit the public portions into the repo. Also from this account we will export the parts that the role account needs, copy them to where the role account can access them, and import them as the role account.\n\nProTip: If asked to generate entropy, consider running this on the same machine in another window: `sudo dd if=/dev/sda of=/dev/null`\n\nFor the rest of this doc, you'll need to make the following substitutions:\n\n- ROLEUSER: svc_deployacct or whatever your role account's name is.\n- NEWMASTER: the machine this role account exists on.\n- SECUREHOST: The machine you use to create the keys.\n\nNOTE: This should be more automated/scripted. Patches welcome.\n\nOn SECUREHOST, create the puppet master's keys:\n\n```\n$ mkdir /tmp/NEWMASTER\n$ cd /tmp/NEWMASTER\n$ gpg --homedir . --gen-key\nYour selection?\n   (1) RSA and RSA (default)\nWhat keysize do you want? (2048) DEFAULT\nKey is valid for? (0) DEFAULT\n\n# Real name: Puppet CI Deploy Account\n# Email address: svc_deployacct@hostname.domain.name\n```\n\nNOTE: Rather than a real email address, use the username@FQDN of the host the key will be used on. If you use this role account on many machines, each should have its own key. By using the FQDN of the host, you will be able to know which key is which. In this doc, we'll refer to username@FQDN as $KEYNAME\n\nSave the passphrase somewhere safe!\n\nCreate a sub-key that has no password:\n\n```\n$ gpg --homedir . --edit-key svc_deployacct\ngpg> addkey\n(enter passphrase)\n  Please select what kind of key you want:\n   (3) DSA (sign only)\n   (4) RSA (sign only)\n   (5) Elgamal (encrypt only)\n   (6) RSA (encrypt only)\nYour selection? 6\nWhat keysize do you want? (2048)\nKey is valid for? (0)\nCommand> key 2\n(the new subkey has a \"*\" next to it)\nCommand> passwd\n(enter the main key's passphrase)\n(enter an empty passphrase for the subkey... confirm you want to do this)\nCommand> save\n```\n\nNow securely export this directory to NEWMASTER:\n\n```\ngpg --homedir . --export -a svc_sadeploy >/tmp/NEWMASTER/pubkey.txt\ntar cvf /tmp/keys.tar .\nrsync -avP /tmp/keys.tar NEWMASTER:/tmp/.\n```\n\nOn NEWMASTER, receive the new GnuPG config:\n\n```\nsudo -u svc_deployacct bash\nmkdir -m 0700 -p ~/.gnupg\ncd ~/.gnupg && tar xpvf /tmp/keys.tar\n```\n\n<!---\nBack on SECUREHOST, import the pubkey into the repository.\n\n```\n$ cd .blackbox\n$ gpg --homedir . --import /tmp/NEWMASTER/pubkey.txt\n```\n-->\n\nBack on SECUREHOST, add the new email address to .blackbox/blackbox-admins.txt:\n\n```\ncd /path/to/the/repo\nblackbox_addadmin $KEYNAME /tmp/NEWMASTER\n```\n\nVerify that secring.gpg is a zero-length file. If it isn't, you have somehow added a private key to the keyring. Start over.\n\n```\ncd .blackbox\nls -l secring.gpg\n```\n\nCommit the recent changes:\n\n```\ncd .blackbox\ngit commit -m\"Adding key for KEYNAME\" pubring.gpg trustdb.gpg blackbox-admins.txt\n```\n\nRegenerate all encrypted files with the new key:\n\n```\nblackbox_update_all_files\ngit status\ngit commit -m\"updated encryption\" -a\ngit push\n```\n\nOn NEWMASTER, import the keys and decrypt the files:\n\n```\nsudo -u svc_sadeploy bash   # Become the role account.\ngpg --import /etc/puppet/.blackbox/pubring.gpg\nexport PATH=$PATH:/path/to/blackbox/bin\nblackbox_postdeploy\nsudo -u puppet cat /etc/puppet/hieradata/blackbox.yaml # or any encrypted file.\n```\n\nProTip: If you get \"gpg: decryption failed: No secret key\" then you forgot to re-encrypt blackbox.yaml with the new key.\n\nOn SECUREHOST, securely delete your files:\n\n```\ncd /tmp/NEWMASTER\n# On machines with the \"shred\" command:\nshred -u /tmp/keys.tar\nfind . -type f -print0 | xargs -0 shred -u\n# All else:\nrm -rf /tmp/NEWMASTER\n```\n\nAlso shred any other temporary files you may have made.\n\nReplacing expired keys\n======================\n\nIf someone's key has already expired, blackbox will stop\nencrypting.  You see this error:\n\n```\n$ blackbox_edit_end modified_file.txt\n--> Error: can't re-encrypt because a key has expired.\n```\n\nFYI: Your repo may use `keyrings/live` instead of `.blackbox`. See \"Where is the configuration stored?\"\n\nYou can also detect keys that are about to expire by issuing this command and manually reviewing the \"expired:\" dates:\n\n    gpg --homedir=.blackbox  --list-keys\n\nor... list UIDs that will expire within 1 month from today: (Warning: this also lists keys without an expiration date)\n\n    gpg --homedir=.blackbox --list-keys  --with-colons --fixed-list-mode  | grep ^uid | awk -F: '$6 < '$(( $(date +%s) + 2592000))\n\nHere's how to replace the key:\n\n- Step 1. Administrator removes expired user:\n\nWarning: This process will erase any unencrypted files that you were in the process of editing. Copy them elsewhere and restore the changes when done.\n\n```\nblackbox_removeadmin expired_user@example.com\n# This next command overwrites any changed unencrypted files. See warning above.\nblackbox_update_all_files\ngit commit -m \"Re-encrypt all files\"\ngpg --homedir=.blackbox --delete-key expired_user@example.com\ngit commit -m 'Cleaned expired_user@example.com from keyring'  .blackbox/*\ngit push\n```\n\n- Step 2. Expired user adds an updated key:\n\n```\ngit pull\nblackbox_addadmin updated_user@example.com\ngit commit -m'NEW ADMIN: updated_user@example.com .blackbox/pubring.gpg .blackbox/trustdb.gpg .blackbox/blackbox-admins.txt\ngit push\n```\n\n- Step 3. Administrator re-encrypts all files with the updated key of the expired user:\n\n```\ngit pull\ngpg --import .blackbox/pubring.gpg\nblackbox_update_all_files\ngit commit -m \"Re-encrypt all files\"\ngit push\n```\n\n- Step 4: Clean up:\n\nAny files that were temporarily copied in the first step so as to not be overwritten can now be copied back and re-encrypted with the `blackbox_edit_end` command.\n\n(Thanks to @chishaku for finding a solution to this problem!)\n\n### Configure git to show diffs in encrypted files\n\nIt's possible to tell Git to decrypt versions of the file before running them through `git diff` or `git log`. To achieve this do:\n\n- Add the following to `.gitattributes` at the top of the git repository:\n\n```\n*.gpg diff=blackbox\n```\n\n- Add the following to `.git/config`:\n\n```\n[diff \"blackbox\"]\n    textconv = gpg --use-agent -q --batch --decrypt\n````\n\nAnd now commands like `git log -p file.gpg` will show a nice log of the changes in the encrypted file.\n\nSome common errors\n==================\n\n`gpg: filename: skipped: No public key` -- Usually this means there is an item in `.blackbox/blackbox-admins.txt` that is not the name of the key. Either something invalid was inserted (like a filename instead of a username) or a user has left the organization and their key was removed from the keychain, but their name wasn't removed from the blackbox-admins.txt file.\n\n`gpg: decryption failed: No secret key` -- Usually means you forgot to re-encrypt the file with the new key.\n\n`Error: can't re-encrypt because a key has expired.` -- A user's key has expired and can't be used to encrypt any more. Follow the [Replace expired keys](#replace-expired-keys) tip.\n\nFYI: Your repo may use `keyrings/live` instead of `.blackbox`. See \"Where is the configuration stored?\"\n\nUsing Blackbox without a repo\n=============================\n\nIf the files are copied out of a repo they can still be decrypted and edited. Obviously edits, changes to keys, and such will be lost if they are made outside the repo. Also note that commands are most likely to only work if run from the base directory (i.e. the parent to the .blackbox directory).\n\nThe following commands have been tested outside a repo:\n\n- `blackbox_postdeploy`\n- `blackbox_edit_start`\n- `blackbox_edit_end`\n\nSome Subversion gotchas\n=======================\n\nThe current implementation will store the blackbox in `/keyrings` at the root of the entire repo.  This will create an issue between environments that have different roots (i.e. checking out `/` on development vs `/releases/foo` in production). To get around this, you can `export BLACKBOX_REPOBASE=/path/to/repo` and set a specific base for your repo.\n\nThis was originally written for git and supports a two-phase commit, in which `commit` is a local commit and \"push\" sends the change upstream to the version control server when something is registered or deregistered with the system.  The current implementation will immediately `commit` a file (to the upstream subversion server) when you execute a `blackbox_*` command.\n\nUsing Blackbox when gpg2 is installed next to gpg\n=================================================\n\nIn some situations, team members or automated roles need to install gpg\n2.x alongside the system gpg version 1.x to catch up with the team's gpg\nversion. On Ubuntu 16, you can ```apt-get install gnupg2``` which\ninstalls the binary gpg2. If you want to use this gpg2 binary, run every\nblackbox command with GPG=gpg2.\n\nFor example:\n\n```\nGPG=gpg2 blackbox_postdeploy\n```\n\nHow to submit bugs or ask questions?\n====================================\n\nWe welcome questions, bug reports and feedback!\n\nThe best place to start is to join the [blackbox-project mailing list](https://groups.google.com/d/forum/blackbox-project) and ask there.\n\nBugs are tracked here in Github. Please feel free to [report bugs](https://github.com/StackExchange/blackbox/issues) yourself.\n\nDeveloper Info\n==============\n\nCode submissions are gladly welcomed! The code is fairly easy to read.\n\nGet the code:\n\n```\ngit clone git@github.com:StackExchange/blackbox.git\n```\n\nTest your changes:\n\n```\nmake confidence\n```\n\nThis runs through a number of system tests. It creates a repo, encrypts files, decrypts files, and so on. You can run these tests to verify that the changes you made didn't break anything. You can also use these tests to verify that the system works with a new operating system.\n\nPlease submit tests with code changes:\n\nThe best way to change BlackBox is via Test Driven Development. First add a test to `tools/confidence.sh`. This test should fail, and demonstrate the need for the change you are about to make. Then fix the bug or add the feature you want. When you are done, `make confidence` should pass all tests. The PR you submit should include your code as well as the new test. This way the confidence tests accumulate as the system grows as we know future changes don't break old features.\n\nNote: The tests currently assume \"git\" and have been tested only on CentOS, Mac OS X, and Cygwin. Patches welcome!\n\nAlternatives\n============\n\nHere are other open source packages that do something similar to BlackBox. If you like them better than BlackBox, please use them.\n\n- [git-crypt](https://www.agwa.name/projects/git-crypt/)\n- [Pass](http://www.zx2c4.com/projects/password-store/)\n- [Transcrypt](https://github.com/elasticdog/transcrypt)\n- [Keyringer](https://keyringer.pw/)\n- [git-secret](https://github.com/sobolevn/git-secret)\n\ngit-crypt has the best git integration. Once set up it is nearly transparent to the users. However it only works with git.\n\n\nLicense\n=======\n\nThis content is released under the MIT License.\nSee the [LICENSE.txt](LICENSE.txt) file."
}
